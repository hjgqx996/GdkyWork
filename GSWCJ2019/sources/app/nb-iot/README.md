# NB-IoT Driver

----------

# 1. 简述

> **NB-IoT** [窄带物联网 | NarrowBand – Internet of Things]，只消耗大约180KHz的带宽，支持低功耗设备在广域网的蜂窝数据连接。
> NB-IoT Driver驱动程序旨在提供通用应用层接口，具备维护NB网络，使不同项目硬件和NB模块具备易移植、增加和修改功能。

## 1.1 主要功能

- 统一的底层硬件接口（OS和非OS系统）和应用层接口；
- FIFO数据缓存管理(nb_buffer)，使数据接收和处理过程分离；
- AT指令通用处理，采用[ProtoThreads](http://dunkels.com/adam/pt/)事件驱动框架，按功能模块处理模块AT指令(nb_threads)，并提供通用的AT回复字符处理方法(nb_parser)；
- 提供一个可供用户修改的NB设备网络维护状态机应用实例(nb_app)；

## 1.2 驱动框架

![驱动框架](images/nb_frame.png)

## 1.3 驱动说明

- **doc** 目录包含驱动相关说明文档
- **inc** 目录包含驱动所有头文件，其中 **inc/pt** 目录为[ProtoThreads](http://dunkels.com/adam/pt/)事件驱动宏
  - `nb_config.h` 驱动参数配置项
  - `nb_private.h` 驱动私有对象类型和宏定义，如AT指令类型定义，指令参数定义，NB驱动对象所有变量类型定义，以及驱动使用的 go功能宏定义
  - `nb_typedef.h` 驱动公共类型定义，如函数返回错误类型定义，回调事件和参数类型定义等
  
- **port** 目录包含驱动移植模板源码
  - `nb_hw_stm32l15x.c` 源码为硬件层接口，包含串口和电源，复位引脚控制
  - `nb_os_freertos.c` 源码为OS层接口，包含操作系统互斥访问
  
- **src** 目录包含驱动源码
  - `nb.c` 源码为操作模块AT指令和应用操作驱动层调用程序接口，如判断是否空闲状态，获取执行最后一次操作的错误状态，处理接收模块的数据，更新滴答计数器，将串口收到的的数据写入到驱动层，检查状态调用回调函数。
  - `nb_app.c` 源码为实现NB网络在线维护，用户数据缓存组包发送，接收。
  - `nb_buffer.c` 源码为提供数据收发FIFO（First In First Out）先入先出缓存管理源码。
  - `nb_parser.c` 源码为模块回复的AT指令字符解析。
  - `nb_threads.c` 源码为模块AT指令执行字符填充和返回状态等待判断,以及事件回调函数处理。

# 2. 应用

### 2.1 驱动移植

- 1. 根据所移植的软硬件平台，修改NB驱动全局配置配置文件(nb_config.h)
- 2. 修改port目录nb_hw_x.c硬件初始化和引脚功能(串口初始化,发送和接收处理，电源和复位引脚控制)，如果使用OS，还需要实现nb_os_x.c与操作系统相关功能(多线程互斥访问，动态内存分配)
- 3. 将nb-iot目录src和port目录源文件加载到项目工程，并添加components/usrlibc/libstdc.c(nb_app.c使用)，开发环境包含nb-iot头文件目录inc、inc/pt，此时应能够编译成功。

### 2.2 应用编程

- 1. 应用程序常用的功能基本包含在nb_app.h(应用层)和nb.h(直接操作模块)文件内;
    - 1. 第一步调用`nbAppInit()`初始化NB-IoT驱动
    - 2. 第二步在定时器中断或者周期调用`nbUpdateTime()`,此函数只对滴答计数变量加上给定的2次调用间隔毫秒时间值，对中断影响可以忽略，并且调用频率无需太快,此值只用于命令操作超时判断,一般100ms以内即可。
    - 3. 第三步如果使能了NB_CFG_OS或NB_CFG_ASYNC模式,需要在高优先级或者中断内轮询调用`nbUpdate()`,此函数用于处理模块发送的字符数据，需保证尽量高的频率调用,以免接收缓存溢出丢失数据。
    - 4. 在主任务循环中调用`nbAppPoll()`,此函数管理NB-IoT网络状态和AT指令处理。此时NB驱动应能够正常运行，如果需要nb_app管理应用数据组包发送和接收，可根据需要修改nb_app.c文件，添加相应功能。

- 2. NB-IoT网络状态机流程图

![网络状态机](images/nb_net_state.png)


# 3. 维护

### 3.1 添加AT指令

- 1. 先在`NB_Cmd_t`定义按照类型定义AT指令码；如果需要参数，在`NB_CmdParam_t`定义参数名称和类型；如果有返回参数需要保存，在`NB_t`定义参数名称和类型；如果需要定义特殊返回正确和错误提示，在`NB_t`内的 *Evts* 标志定义相应的标志位；如果需要该指令需要调用回调函数通知应用层处理返回事件，在`NB_t`内的 *Flags* 标志定义相应的标志位，然后在 `nbProcessCallbacks()`函数内处理标志位，调用回调函数处理。
- 2.在`nb.c`内按照分类增加函数定义；在`nb_threads.c`相应线程中添加AT指令字符填充和返回状态判断；如果返回响应命令不是通用的"OK"或"ERROR"字符串，或者响应字符串需要解析参数，在`nb_parse_received()`按照格式增加响应字符串判断，并增加参数解析函数。

## 版权信息

Copyright(C) 2018-2028 [GDKY](www.gdkeya.com) All Rights Reserved
